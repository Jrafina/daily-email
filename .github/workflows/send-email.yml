name: Daily Email Sender

# è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ï¼ˆæ¯å¤© UTC æ—¶é—´ 0:00ï¼Œå³åŒ—äº¬æ—¶é—´ 8:00ï¼‰
  schedule:
    - cron: '23 08 * * *'  # æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
    
  # 2. æ‰‹åŠ¨è§¦å‘ï¼ˆå¯é€‰ï¼‰
  workflow_dispatch:
    # å¯ä»¥æ·»åŠ è¾“å…¥å‚æ•°
    inputs:
      custom_message:
        description: 'è‡ªå®šä¹‰æ¶ˆæ¯'
        required: false
        default: 'Hello World!'
        
  # 3. æ¨é€ä»£ç æ—¶è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main, master ]
    
  # 4. åˆ›å»º Pull Request æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  pull_request:
    branches: [ main, master ]

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  TIMEZONE: "Asia/Shanghai"

# å·¥ä½œæµä»»åŠ¡
jobs:
  # ä»»åŠ¡ 1ï¼šå‘é€é‚®ä»¶
  send-email:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # æ­¥éª¤
    steps:
      # æ­¥éª¤ 1ï¼šæ‰“å°å¼€å§‹ä¿¡æ¯
      - name: Print start message
        run: echo "ğŸ¯ å¼€å§‹å‘é€æ¯æ—¥é‚®ä»¶..."
        
      # æ­¥éª¤ 2ï¼šæ£€å‡ºä»£ç ï¼ˆå¯é€‰ï¼Œå¦‚æœæ²¡æœ‰æ–‡ä»¶éœ€è¦è¯»å–ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # æ­¥éª¤ 3ï¼šå®‰è£…å¿…è¦çš„å·¥å…·
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          echo "å·¥å…·å®‰è£…å®Œæˆ"
          
      # æ­¥éª¤ 4ï¼šè·å–å½“å‰æ—¶é—´
      - name: Get current time
        id: time
        run: |
          echo "UTCæ—¶é—´: $(date -u)"
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
      # æ­¥éª¤ 5ï¼šå‘é€é‚®ä»¶ï¼ˆä½¿ç”¨ SMTPï¼‰
      - name: Send email via SMTP
        id: send-email
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP æœåŠ¡å™¨é…ç½®
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          
          # é‚®ç®±è®¤è¯
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          
          # é‚®ä»¶å†…å®¹
          subject: "ğŸ“§ æ¯æ—¥é—®å€™ - ${{ steps.time.outputs.time }}"
          body: |
            ğŸŒŸ Hello World! ğŸŒŸ
            
            è¿™æ˜¯æ¥è‡ª GitHub Actions çš„è‡ªåŠ¨é‚®ä»¶ï¼
            
            ğŸ• å‘é€æ—¶é—´ï¼š${{ steps.time.outputs.time }}
            ğŸ“‚ ä»“åº“ï¼š${{ github.repository }}
            ğŸ”§ å·¥ä½œæµï¼š${{ github.workflow }}
            
            ç¥ä½ ä»Šå¤©æ„‰å¿«ï¼ğŸ‰
            
            ---
            ï¼ˆè¿™æ˜¯ä¸€å°è‡ªåŠ¨å‘é€çš„é‚®ä»¶ï¼Œè¯·å‹¿å›å¤ï¼‰
            
          # HTML æ ¼å¼å†…å®¹ï¼ˆå¯é€‰ï¼Œä¼šè¦†ç›–ä¸Šé¢çš„çº¯æ–‡æœ¬ï¼‰
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }
                    .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
                    .highlight { color: #667eea; font-weight: bold; }
                    .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; color: #777; font-size: 12px; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>ğŸŒŸ Hello World! ğŸŒŸ</h1>
                    </div>
                    <div class="content">
                        <p>è¿™æ˜¯æ¥è‡ª GitHub Actions çš„è‡ªåŠ¨é‚®ä»¶ï¼</p>
                        
                        <h3>ğŸ“‹ é‚®ä»¶è¯¦æƒ…</h3>
                        <ul>
                            <li>ğŸ• å‘é€æ—¶é—´ï¼š${{ steps.time.outputs.time }}</li>
                            <li>ğŸ“‚ ä»“åº“ï¼š<span class="highlight">${{ github.repository }}</span></li>
                            <li>ğŸ”§ å·¥ä½œæµï¼š<span class="highlight">${{ github.workflow }}</span></li>
                            <li>ğŸ¯ è§¦å‘æ–¹å¼ï¼š${{ github.event_name }}</li>
                        </ul>
                        
                        <p>ç¥ä½ ä»Šå¤©æ„‰å¿«ï¼ğŸ‰</p>
                        
                        <div class="footer">
                            <p>è¿™æ˜¯ä¸€å°è‡ªåŠ¨å‘é€çš„é‚®ä»¶ï¼Œè¯·å‹¿å›å¤</p>
                            <p>å‘é€è€…ï¼šGitHub Actions â€¢ ${{ secrets.EMAIL_USER }}</p>
                        </div>
                    </div>
                </div>
            </body>
            </html>
          
          # å‘ä»¶äººä¿¡æ¯
          from: GitHub Actions Bot <${{ secrets.EMAIL_USER }}>
          
          # æ”¶ä»¶äººä¿¡æ¯
          to: ${{ secrets.TO_EMAIL }}
          
          # æŠ„é€å’Œå¯†é€ï¼ˆå¯é€‰ï¼‰
          # cc: æŠ„é€é‚®ç®±1,æŠ„é€é‚®ç®±2
          # bcc: å¯†é€é‚®ç®±
          
          # å®‰å…¨è¿æ¥
          secure: true
          convert_markdown: false
          
          # é™„ä»¶ï¼ˆå¯é€‰ï¼‰
          # attachments: file1.txt,file2.pdf
          
          # é‚®ä»¶ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
          # priority: high
          
      # æ­¥éª¤ 6ï¼šå‘é€å®Œæˆæç¤º
      - name: Print success message
        if: steps.send-email.outcome == 'success'
        run: echo "âœ… é‚®ä»¶å‘é€æˆåŠŸï¼"
        
      # æ­¥éª¤ 7ï¼šé”™è¯¯å¤„ç†ï¼ˆå¯é€‰ï¼‰
      - name: Print failure message
        if: steps.send-email.outcome == 'failure'
        run: echo "âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ï¼"
        
      # æ­¥éª¤ 8ï¼šå‘é€é€šçŸ¥åˆ° GitHubï¼ˆå¯é€‰ï¼‰
      - name: Send notification to GitHub
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          echo "å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "çŠ¶æ€: ${{ job.status }}"
          
  # ä»»åŠ¡ 2ï¼šè®°å½•æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
  log-job:
    needs: send-email  # ä¾èµ– send-email ä»»åŠ¡
    runs-on: ubuntu-latest
    if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
    
    steps:
      - name: Log execution
        run: |
          echo "ğŸ“… æ¯æ—¥é‚®ä»¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ“§ é‚®ä»¶ä»»åŠ¡çŠ¶æ€: ${{ needs.send-email.result }}"
          echo "ğŸ”„ å·¥ä½œæµ URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
